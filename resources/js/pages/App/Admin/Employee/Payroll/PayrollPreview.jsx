import { useState, useEffect } from 'react';
import { usePage, router } from '@inertiajs/react';
import AdminLayout from '@/layouts/AdminLayout';
import { Box, Card, CardContent, Typography, Button, Grid, Table, TableBody, TableCell, TableContainer, TableHead, TableRow, Paper, CircularProgress, Pagination, Snackbar, Alert, Collapse, IconButton } from '@mui/material';
import KeyboardArrowDownIcon from '@mui/icons-material/KeyboardArrowDown';
import KeyboardArrowUpIcon from '@mui/icons-material/KeyboardArrowUp';
import axios from 'axios';

const PayrollPreview = ({ period: initialPeriod, token: initialToken }) => {
    const { props } = usePage();
    const [period, setPeriod] = useState(initialPeriod || null);
    const [token, setToken] = useState(initialToken || null);
    const [previewRows, setPreviewRows] = useState([]);
    const [loading, setLoading] = useState(true);
    const [page, setPage] = useState(1);
    const [perPage, setPerPage] = useState(15);
    const [total, setTotal] = useState(0);
    const [lastPage, setLastPage] = useState(1);
    const [processing, setProcessing] = useState(false);
    const [snackbar, setSnackbar] = useState({ open: false, message: '', severity: 'success' });
    const [expanded, setExpanded] = useState({});

    useEffect(() => {
        fetchPreview(page);
    }, [page, perPage, period, token]);

    const fetchPreview = async (pageNumber = 1) => {
        if (!period) return;
        setLoading(true);
        try {
            const params = {
                page: pageNumber,
                per_page: perPage,
            };

            // attach token if provided (server will resolve employee ids from cache)
            if (token) {
                params.token = token;
            }

            const response = await axios.get(`/api/payroll/periods/${period.id}/preview`, { params });
            if (response.data.success) {
                const preview = response.data.preview;
                // paginator structure: data, current_page, last_page, per_page, total
                setPreviewRows(preview.data || []);
                setPage(preview.current_page || 1);
                setPerPage(preview.per_page || 15);
                setTotal(preview.total || 0);
                setLastPage(preview.last_page || 1);
            }
        } catch (error) {
            console.error('Error fetching preview:', error);
        } finally {
            setLoading(false);
        }
    };

    const handlePageChange = (event, value) => {
        setPage(value);
    };

    const handleProcessPayroll = async () => {
        if (!period) return;
        setProcessing(true);
        try {
            const payload = {};
            if (token) payload.token = token;

            const response = await axios.post(`/api/payroll/periods/${period.id}/process`, payload);

            if (response.data.success) {
                setSnackbar({ open: true, message: 'Payroll processed successfully', severity: 'success' });
                // redirect to payslips
                setTimeout(() => {
                    router.visit(route('employees.payroll.payslips'));
                }, 1200);
            } else {
                setSnackbar({ open: true, message: response.data.message || 'Error processing payroll', severity: 'error' });
            }
        } catch (err) {
            console.error(err);
            setSnackbar({ open: true, message: 'Error processing payroll', severity: 'error' });
        } finally {
            setProcessing(false);
        }
    };

    const handleCloseSnackbar = () => setSnackbar((s) => ({ ...s, open: false }));

    return (
        <AdminLayout>
            <Box sx={{ p: 3 }}>
                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 4 }}>
                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
                        <Button onClick={() => router.visit(route('employees.payroll.process'))} sx={{ color: '#063455' }}>
                            Back to Payroll
                        </Button>
                        <Typography variant="h4" sx={{ color: '#063455', fontWeight: 600 }}>
                            Payroll Preview
                        </Typography>
                    </Box>
                </Box>

                <Grid container spacing={3}>
                    <Grid item xs={12}>
                        <Card>
                            <CardContent>
                                <Typography variant="h6" sx={{ color: '#063455', fontWeight: 600, mb: 2 }}>
                                    Period: {period?.period_name || 'N/A'}
                                </Typography>

                                {loading ? (
                                    <Box sx={{ textAlign: 'center', py: 6 }}>
                                        <CircularProgress />
                                    </Box>
                                ) : (
                                    <>
                                        <TableContainer component={Paper} sx={{ maxHeight: 500 }}>
                                            <Table stickyHeader size="small">
                                                <TableHead>
                                                    <TableRow>
                                                        <TableCell sx={{ fontWeight: 600 }}>Employee</TableCell>
                                                        <TableCell sx={{ fontWeight: 600 }}>Department</TableCell>
                                                        <TableCell sx={{ fontWeight: 600 }}>Basic Salary</TableCell>
                                                        <TableCell sx={{ fontWeight: 600 }}>Allowances</TableCell>
                                                        <TableCell sx={{ fontWeight: 600 }}>Deductions</TableCell>
                                                        <TableCell sx={{ fontWeight: 600 }}>Order Deductions</TableCell>
                                                        <TableCell sx={{ fontWeight: 600 }}>Gross Salary</TableCell>
                                                        <TableCell sx={{ fontWeight: 600 }}>Net Salary</TableCell>
                                                    </TableRow>
                                                </TableHead>
                                                <TableBody>
                                                    {previewRows.map((r) => (
                                                        <>
                                                            <TableRow key={`row-${r.employee_id}`}>
                                                                <TableCell>
                                                                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                                                        <IconButton size="small" onClick={() => setExpanded((p) => ({ ...p, [r.employee_id]: !p[r.employee_id] }))}>
                                                                            {expanded[r.employee_id] ? <KeyboardArrowUpIcon /> : <KeyboardArrowDownIcon />}
                                                                        </IconButton>
                                                                        <Box>
                                                                            <Typography variant="subtitle2">{r.employee_name}</Typography>
                                                                            <Typography variant="caption" color="textSecondary">
                                                                                {r.employee_number}
                                                                            </Typography>
                                                                        </Box>
                                                                    </Box>
                                                                </TableCell>
                                                                <TableCell>{r.department}</TableCell>
                                                                <TableCell>{(r.basic_salary || 0).toLocaleString()}</TableCell>
                                                                <TableCell>{(r.total_allowances || 0).toLocaleString()}</TableCell>
                                                                <TableCell>{(r.total_deductions || 0).toLocaleString()}</TableCell>
                                                                <TableCell>{(r.total_order_deductions || 0).toLocaleString()}</TableCell>
                                                                <TableCell>{(r.gross_salary || 0).toLocaleString()}</TableCell>
                                                                <TableCell sx={{ fontWeight: 600 }}>{(r.net_salary || 0).toLocaleString()}</TableCell>
                                                            </TableRow>

                                                            <TableRow>
                                                                <TableCell style={{ paddingBottom: 0, paddingTop: 0 }} colSpan={8}>
                                                                    <Collapse in={!!expanded[r.employee_id]} timeout="auto" unmountOnExit>
                                                                        <Box sx={{ margin: 1 }}>
                                                                            <Typography variant="subtitle2">Order Deductions</Typography>
                                                                            {r.order_deductions && r.order_deductions.length > 0 ? (
                                                                                r.order_deductions.map((o) => {
                                                                                    const alreadyDeducted = !!o.deducted_at;
                                                                                    return (
                                                                                        <Box
                                                                                            key={`order-${o.id}`}
                                                                                            sx={{
                                                                                                display: 'flex',
                                                                                                justifyContent: 'space-between',
                                                                                                py: 0.5,
                                                                                                opacity: alreadyDeducted ? 0.6 : 1,
                                                                                                fontStyle: alreadyDeducted ? 'italic' : 'normal',
                                                                                            }}
                                                                                        >
                                                                                            <Typography variant="body2">{o.paid_at ? new Date(o.paid_at).toLocaleString() : 'â€”'}</Typography>
                                                                                            <Typography variant="body2">{Number(o.amount || 0).toLocaleString()}</Typography>
                                                                                            <Box sx={{ textAlign: 'right' }}>
                                                                                                <Typography variant="caption" color="textSecondary">
                                                                                                    {o.note || ''}
                                                                                                </Typography>
                                                                                                {o.deducted_at && (
                                                                                                    <Typography variant="caption" color="textSecondary" sx={{ display: 'block' }}>
                                                                                                        Deducted: {new Date(o.deducted_at).toLocaleString()}
                                                                                                    </Typography>
                                                                                                )}
                                                                                            </Box>
                                                                                        </Box>
                                                                                    );
                                                                                })
                                                                            ) : (
                                                                                <Typography variant="body2" color="textSecondary">
                                                                                    No CTS order deductions for this period.
                                                                                </Typography>
                                                                            )}
                                                                        </Box>
                                                                    </Collapse>
                                                                </TableCell>
                                                            </TableRow>
                                                        </>
                                                    ))}
                                                </TableBody>
                                            </Table>
                                        </TableContainer>

                                        <Box sx={{ display: 'flex', justifyContent: 'center', mt: 2 }}>
                                            <Pagination count={lastPage} page={page} onChange={handlePageChange} color="primary" />
                                        </Box>
                                        <Box sx={{ display: 'flex', justifyContent: 'center', gap: 2, mt: 2 }}>
                                            <Button variant="contained" color="primary" onClick={handleProcessPayroll} disabled={processing}>
                                                {processing ? 'Processing...' : 'Process Payroll'}
                                            </Button>
                                        </Box>
                                    </>
                                )}
                            </CardContent>
                        </Card>
                    </Grid>
                </Grid>
            </Box>
            <Snackbar open={snackbar.open} autoHideDuration={6000} onClose={handleCloseSnackbar} anchorOrigin={{ vertical: 'bottom', horizontal: 'right' }}>
                <Alert onClose={handleCloseSnackbar} severity={snackbar.severity} sx={{ width: '100%' }}>
                    {snackbar.message}
                </Alert>
            </Snackbar>
        </AdminLayout>
    );
};

export default PayrollPreview;
